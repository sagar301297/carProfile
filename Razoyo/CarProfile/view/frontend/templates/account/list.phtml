<?php
/** @var \Razoyo\CarProfile\ViewModel\CarData $viewModel */
/** @var $block \Magento\Framework\View\Element\Template */
$viewModel = $block->getData('car_list');
$carData = $viewModel->getCarData();
$selectedCarId = $viewModel->getSelectedCar();
$cars = $carData['cars'] ?? [];
$token = $carData['token'] ?? '';
?>

<div class="car-details" id="car-details"></div>
<div id="no-car-selected">
    <p><?= $block->escapeHtml(__('Please select a car.')) ?></p>
</div>

<?php if (!empty($cars)): ?>
    <form id="car-profile-form" class="form car-profile" method="post">
        <fieldset class="fieldset">
            <legend class="legend">
                <span><?= $block->escapeHtml(__('Car Selection')) ?></span>
            </legend>
            <div class="field car-select">
                <label for="car-select" class="label">
                    <span><?= $block->escapeHtml(__('Choose a car:')) ?></span>
                </label>
                <div class="control">
                    <select id="car-select" name="car-selection" class="select">
                        <option value=""><?= $block->escapeHtml(__('Select a car')) ?></option>
                        <?php foreach ($cars as $car): ?>
                            <?php
                            $carId = $car['id'] ?? '';
                            $year = $car['year'] ?? '';
                            $make = $car['make'] ?? '';
                            $model = $car['model'] ?? '';
                            $isSelected = $carId === $selectedCarId ? 'selected' : '';
                            $carLabel = $block->escapeHtml("$year $make $model");
                            ?>
                            <option value="<?= $block->escapeHtmlAttr($carId) ?>" <?= $isSelected ?>>
                                <?= $carLabel ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>
        </fieldset>
        <div id="car-profile-messages"></div>
    </form>

    <script type="text/x-magento-init">
    {
        "#car-select": {
            "Razoyo_CarProfile/js/car-profiles": {
                "token": "<?= $block->escapeJs($token) ?>",
                "selectedCarId": "<?= $block->escapeJs($selectedCarId ?: '') ?>"
            }
        }
    }
    </script>
<?php else: ?>
    <p><?= $block->escapeHtml(__('No cars are available at the moment.')) ?></p>
<?php endif; ?>